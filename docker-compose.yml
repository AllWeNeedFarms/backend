services:
  # 'backend' ì„œë¹„ìŠ¤ ì´ë¦„ì„ 'node-app'ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì—­í•  ëª…í™•í™” (ê¸°ì¡´ Dockerfileê³¼ ì¼ì¹˜)
  node-app: 
    # ë¡œì»¬ì—ì„œëŠ” ì´ build ì„¤ì •ì„ ì‚¬ìš©í•˜ì§€ë§Œ, ì„œë²„ì—ì„œëŠ” ì•„ë˜ imageë¥¼ pull ë°›ìŠµë‹ˆë‹¤.
    build:
      context: .
      dockerfile: Dockerfile
    # CI/CDë¥¼ ìœ„í•´ Docker Hub ì´ë¯¸ì§€ ì´ë¦„ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
    image: jeehokim/allweneedfarm-backend:v1.0.0 # â—€ï¸ [ìˆ˜ì • ì œì•ˆ 2] ë³¸ì¸ì˜ DockerHub ì´ë¯¸ì§€
    restart: unless-stopped
    env_file:
      - .env
    # â›”ï¸ [ìˆ˜ì • ì œì•ˆ 1] ë³´ì•ˆì„ ìœ„í•´ ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œì„ ì œê±°í•©ë‹ˆë‹¤. â›”ï¸
    # ports:
    #   - "${PORT}:${PORT}"
    networks:
      - app-net
    # ğŸªµ [ìˆ˜ì • ì œì•ˆ 3] CloudWatch ë¡œê¹… ì„¤ì • ì¶”ê°€
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "allweneedfarm-backend-logs"
        awslogs-region: "ap-northeast-2" # ë³¸ì¸ì˜ ë¦¬ì „
        # [ìˆ˜ì •] 'awslogs-stream-prefix'ë¥¼ 'awslogs-stream'ìœ¼ë¡œ ë³€ê²½í•˜ê³ , ìŠ¤íŠ¸ë¦¼ ì´ë¦„ì„ ì§ì ‘ ì§€ì •í•©ë‹ˆë‹¤.
        awslogs-stream: "node-app-stream"
        awslogs-create-group: "true"

  nginx:
    image: nginx:alpine
    depends_on:
      - node-app # ì„œë¹„ìŠ¤ ì´ë¦„ ë³€ê²½ì— ë”°ë¼ ìˆ˜ì •
    ports:
      - "80:80"
      # - "443:443" # 443 í¬íŠ¸ëŠ” ë‚˜ì¤‘ì— CloudFrontì™€ ì—°ë™ í›„ HTTPS ì„¤ì • ì‹œ ì‚¬ìš© ì˜ˆì •
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - app-net
    # ğŸªµ [ìˆ˜ì • ì œì•ˆ 3] Nginx ë¡œê·¸ë„ CloudWatchë¡œ ë³´ëƒ…ë‹ˆë‹¤.
    logging:
      driver: "awslogs"
      options:
        awslogs-group: "allweneedfarm-backend-logs"
        awslogs-region: "ap-northeast-2" # ë³¸ì¸ì˜ ë¦¬ì „
         # [ìˆ˜ì •] Nginxë„ ë§ˆì°¬ê°€ì§€ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        awslogs-stream: "nginx-stream"
        awslogs-create-group: "true"
      
networks:
  app-net:
    driver: bridge